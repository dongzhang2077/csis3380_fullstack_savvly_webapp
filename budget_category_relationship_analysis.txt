# é¢„ç®—ä¸ç±»åˆ«å…³ç³»åˆ†æ
## å½“å‰æ•°æ®æ¨¡å‹ä¸­çš„é¢„ç®—-ç±»åˆ«å…³è”é—®é¢˜

---

## 1. å½“å‰çŠ¶å†µåˆ†æ

### 1.1 æ•°æ®æ¨¡å‹å…³ç³»

**Budgetæ¨¡å‹**ï¼š
```javascript
// server/models/Budget.js
const budgetSchema = new mongoose.Schema({
  userId: { type: String, required: true, index: true },
  category: { type: String, required: true, trim: true },  // ç±»åˆ«åç§°
  amount: { type: Number, required: true, min: 0 },
  // ...
});
```

**Transactionæ¨¡å‹**ï¼š
```javascript
// server/models/Transaction.js
const transactionSchema = new mongoose.Schema({
  userId: { type: String, required: true, index: true },
  description: { type: String, required: true, trim: true, maxlength: 120 },
  category: { type: String, required: true, trim: true },  // ç±»åˆ«åç§°
  amount: { type: Number, required: true },
  isIncome: { type: Boolean, default: false },
  // ...
});
```

### 1.2 å…³é”®é—®é¢˜ï¼šç¼ºä¹ç±»åˆ«ç®¡ç†

**é—®é¢˜æ ¸å¿ƒ**ï¼š
- Budgetå’ŒTransactionéƒ½æœ‰`category`å­—æ®µï¼Œä½†ä¸¤è€…æ˜¯ç‹¬ç«‹çš„
- æ²¡æœ‰ç»Ÿä¸€çš„ç±»åˆ«ç®¡ç†ç³»ç»Ÿ
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥ç±»åˆ«åç§°ï¼Œå®¹æ˜“å‡ºé”™
- æ— æ³•ç¡®ä¿ç±»åˆ«åç§°çš„ä¸€è‡´æ€§

---

## 2. å½“å‰å®ç°æ–¹å¼

### 2.1 å‰ç«¯ç±»åˆ«å¤„ç†

**BudgetFormä¸­çš„ç±»åˆ«è¾“å…¥**ï¼š
```javascript
// client/src/pages/BudgetForm.jsx
<input 
  name="category" 
  className="form-control" 
  value={form.category} 
  onChange={handleChange} 
  required 
  placeholder="e.g. Groceries" 
/>
```

**TransactionFormä¸­çš„ç±»åˆ«è¾“å…¥**ï¼š
```javascript
// å‡è®¾å­˜åœ¨TransactionFormç»„ä»¶
<input 
  name="category" 
  className="form-control" 
  value={form.category} 
  onChange={handleChange} 
  required 
  placeholder="e.g. Groceries" 
/>
```

**Dashboardä¸­çš„ç±»åˆ«æ˜¾ç¤º**ï¼š
```javascript
// client/src/pages/Dashboard.jsx
const getCategoryIcon = (category) => {
  const icons = {
    food: "ğŸ”",
    housing: "ğŸ ",
    transportation: "ğŸš—",
    // ...ç¡¬ç¼–ç çš„å›¾æ ‡æ˜ å°„
  };
  return icons[category.toLowerCase()] || "ğŸ’°";
};
```

### 2.2 åç«¯ç±»åˆ«å¤„ç†

**BudgetæŸ¥è¯¢**ï¼š
```javascript
// server/routes/budgets.js
router.get("/", async (req, res) => {
  const query = { userId: req.user.id };
  // æ²¡æœ‰ç±»åˆ«ç­›é€‰æˆ–ç®¡ç†
  const budgets = await Budget.find(query);
  res.json(budgets);
});
```

**TransactionæŸ¥è¯¢**ï¼š
```javascript
// server/routes/transactions.js
router.get("/", async (req, res) => {
  const transactions = await Transaction.find({ userId: req.user.id });
  // æ²¡æœ‰ç±»åˆ«ç­›é€‰æˆ–ç®¡ç†
  res.json(transactions);
});
```

---

## 3. ç†æƒ³çš„æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 åˆ›å»ºç‹¬ç«‹çš„Categoryæ¨¡å‹

**Categoryæ¨¡å‹**ï¼š
```javascript
// server/models/Category.js - ç†æƒ³è®¾è®¡
const categorySchema = new mongoose.Schema({
  userId: { type: String, required: true, index: true },
  name: { type: String, required: true, trim: true },
  description: { type: String, trim: true },
  color: { type: String, default: "#007bff" },
  icon: { type: String, default: "ğŸ’°" },
}, { timestamps: true });

export default mongoose.model("Category", categorySchema);
```

### 3.2 æ›´æ–°Budgetæ¨¡å‹å¼•ç”¨

**æ”¹è¿›çš„Budgetæ¨¡å‹**ï¼š
```javascript
// server/models/Budget.js - æ”¹è¿›è®¾è®¡
const budgetSchema = new mongoose.Schema({
  userId: { type: String, required: true, index: true },
  categoryId: { 
    type: mongoose.Schema.Types.ObjectId, 
    ref: 'Category', 
    required: true 
  },  // æ›¿ä»£categoryå­—æ®µ
  amount: { type: Number, required: true, min: 0 },
  spent: { type: Number, default: 0, min: 0 },
  month: { type: Number, required: true, min: 1, max: 12 },
  year: { type: Number, required: true, min: 2000 },
  rolloverType: { type: String, enum: ["full", "partial", "none", "goal"], default: "full" },
  notes: String,
}, { timestamps: true });
```

### 3.3 æ›´æ–°Transactionæ¨¡å‹å¼•ç”¨

**æ”¹è¿›çš„Transactionæ¨¡å‹**ï¼š
```javascript
// server/models/Transaction.js - æ”¹è¿›è®¾è®¡
const transactionSchema = new mongoose.Schema({
  userId: { type: String, required: true, index: true },
  description: { type: String, required: true, trim: true, maxlength: 120 },
  categoryId: { 
    type: mongoose.Schema.Types.ObjectId, 
    ref: 'Category', 
    required: true 
  },  // æ›¿ä»£categoryå­—æ®µ
  amount: { type: Number, required: true },
  isIncome: { type: Boolean, default: false },
  date: { type: Date, default: Date.now },
  notes: String,
}, { timestamps: true });
```

---

## 4. æ”¹è¿›çš„APIå®ç°

### 4.1 Categoryç®¡ç†API

**Categoryè·¯ç”±**ï¼š
```javascript
// server/routes/categories.js - æ–°å¢è·¯ç”±
import { Router } from "express";
import Category from "../models/Category.js";
import { authMiddleware } from "../middleware/auth.js";

const router = Router();
router.use(authMiddleware);

// è·å–ç”¨æˆ·çš„æ‰€æœ‰ç±»åˆ«
router.get("/", async (req, res) => {
  try {
    const categories = await Category.find({ userId: req.user.id });
    res.json(categories);
  } catch (error) {
    res.status(500).json({ error: "Failed to load categories" });
  }
});

// åˆ›å»ºæ–°ç±»åˆ«
router.post("/", async (req, res) => {
  try {
    const category = await Category.create({
      ...req.body,
      userId: req.user.id
    });
    res.status(201).json(category);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

export default router;
```

### 4.2 æ›´æ–°çš„Budgetå’ŒTransactionè·¯ç”±

**Budgetè·¯ç”±æ”¹è¿›**ï¼š
```javascript
// server/routes/budgets.js - æ”¹è¿›è®¾è®¡
router.get("/", async (req, res) => {
  try {
    const { categoryId } = req.query;  // æ”¯æŒæŒ‰ç±»åˆ«ç­›é€‰
    
    let query = { userId: req.user.id };
    if (categoryId) {
      query.categoryId = categoryId;  // æŒ‰ç±»åˆ«ç­›é€‰
    }
    
    const budgets = await Budget.find(query)
      .populate('categoryId')  // å¡«å……ç±»åˆ«ä¿¡æ¯
      .sort({ year: -1, month: -1, category: 1 });
    
    res.json(budgets);
  } catch (error) {
    res.status(500).json({ error: "Failed to load budgets" });
  }
});
```

**Transactionè·¯ç”±æ”¹è¿›**ï¼š
```javascript
// server/routes/transactions.js - æ”¹è¿›è®¾è®¡
router.get("/", async (req, res) => {
  try {
    const { categoryId } = req.query;  // æ”¯æŒæŒ‰ç±»åˆ«ç­›é€‰
    
    let query = { userId: req.user.id };
    if (categoryId) {
      query.categoryId = categoryId;  // æŒ‰ç±»åˆ«ç­›é€‰
    }
    
    const transactions = await Transaction.find(query)
      .populate('categoryId')  // å¡«å……ç±»åˆ«ä¿¡æ¯
      .sort({ date: -1 });
    
    res.json(transactions);
  } catch (error) {
    res.status(500).json({ error: "Failed to load transactions" });
  }
});
```

---

## 5. å‰ç«¯æ”¹è¿›å®ç°

### 5.1 Categoryç®¡ç†ç»„ä»¶

**CategoryListç»„ä»¶**ï¼š
```javascript
// client/src/pages/Categories.jsx - æ–°å¢ç»„ä»¶
import { useEffect, useState } from 'react';
import { getCategories, createCategory } from '../services/api';

const Categories = () => {
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  useEffect(() => {
    loadCategories();
  }, []);

  const loadCategories = async () => {
    setLoading(true);
    try {
      const data = await getCategories();
      setCategories(data);
    } catch (err) {
      setError(err.message || 'Failed to load categories');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container py-4">
      <div className="card">
        <div className="card-body">
          <h2>Categories</h2>
          {/* ç±»åˆ«åˆ—è¡¨ */}
          {/* æ·»åŠ æ–°ç±»åˆ«è¡¨å• */}
        </div>
      </div>
    </div>
  );
};

export default Categories;
```

### 5.2 æ”¹è¿›çš„BudgetFormç»„ä»¶

**ç±»åˆ«é€‰æ‹©æ”¹è¿›**ï¼š
```javascript
// client/src/pages/BudgetForm.jsx - æ”¹è¿›è®¾è®¡
import { useEffect, useState } from 'react';
import { getCategories } from '../services/api';

const BudgetForm = () => {
  const [categories, setCategories] = useState([]);
  const [form, setForm] = useState(getInitialForm);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await getCategories();
        setCategories(data);
      } catch (err) {
        console.error('Failed to load categories:', err);
      }
    };
    
    if (isEdit) {
      loadCategories();
    }
  }, [isEdit]);

  return (
    <div className="container py-4">
      <div className="card">
        <div className="card-body">
          <h1>{isEdit ? 'Edit Budget' : 'New Budget'}</h1>
          <form onSubmit={handleSubmit}>
            <div className="row g-3">
              <div className="col-md-6">
                <label className="form-label">Category</label>
                <select 
                  name="categoryId" 
                  className="form-select" 
                  value={form.categoryId} 
                  onChange={handleChange}
                  required
                >
                  <option value="">Select a category</option>
                  {categories.map(cat => (
                    <option key={cat._id} value={cat._id}>
                      {cat.name} ({cat.description})
                    </option>
                  ))}
                </select>
              </div>
              {/* å…¶ä»–å­—æ®µä¿æŒä¸å˜ */}
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};
```

### 5.3 æ”¹è¿›çš„Dashboardç»„ä»¶

**æŒ‰ç±»åˆ«ç»Ÿè®¡**ï¼š
```javascript
// client/src/pages/Dashboard.jsx - æ”¹è¿›è®¾è®¡
const statsByCategory = useMemo(() => {
  // æŒ‰ç±»åˆ«åˆ†ç»„ç»Ÿè®¡
  const categoryStats = {};
  
  budgets.forEach(budget => {
    const category = budget.categoryId?.name || 'Uncategorized';
    if (!categoryStats[category]) {
      categoryStats[category] = {
        budgeted: 0,
        spent: 0,
        transactions: 0
      };
    }
    
    categoryStats[category].budgeted += budget.amount;
    categoryStats[category].spent += budget.spent;
  });
  
  transactions.forEach(txn => {
    const category = txn.categoryId?.name || 'Uncategorized';
    if (categoryStats[category]) {
      categoryStats[category].transactions += 1;
      if (txn.isIncome) {
        categoryStats[category].income += txn.amount;
      } else {
        categoryStats[category].expenses += txn.amount;
      }
    }
  });
  
  return categoryStats;
}, [budgets, transactions]);
```

---

## 6. æ•°æ®è¿ç§»ç­–ç•¥

### 6.1 ç°æœ‰æ•°æ®å¤„ç†

```javascript
// server/scripts/migrateCategories.js - æ•°æ®è¿ç§»è„šæœ¬
import mongoose from 'mongoose';
import Budget from '../models/Budget.js';
import Transaction from '../models/Transaction.js';
import Category from '../models/Category.js';

const migrateCategories = async () => {
  console.log('Starting category migration...');
  
  // 1. è·å–æ‰€æœ‰å”¯ä¸€çš„ç±»åˆ«åç§°
  const uniqueCategories = new Set();
  
  const budgets = await Budget.find({});
  budgets.forEach(budget => {
    if (budget.category) {
      uniqueCategories.add(budget.category.trim().toLowerCase());
    }
  });
  
  const transactions = await Transaction.find({});
  transactions.forEach(txn => {
    if (txn.category) {
      uniqueCategories.add(txn.category.trim().toLowerCase());
    }
  });
  
  console.log(`Found ${uniqueCategories.size} unique categories:`, Array.from(uniqueCategories));
  
  // 2. åˆ›å»ºç±»åˆ«è®°å½•
  const categoryDocs = [];
  for (const categoryName of uniqueCategories) {
    const category = await Category.create({
      name: categoryName,
      description: `${categoryName} expenses`,
      color: '#007bff',
      icon: 'ğŸ’°'
    });
    categoryDocs.push(category);
  }
  
  console.log(`Created ${categoryDocs.length} categories`);
  
  // 3. æ›´æ–°ç°æœ‰è®°å½•
  for (const category of categoryDocs) {
    await Budget.updateMany(
      { category: category.name },
      { $set: { categoryId: category._id } }
    );
    
    await Transaction.updateMany(
      { category: category.name },
      { $set: { categoryId: category._id } }
    );
  }
  
  console.log('Migration completed successfully');
  process.exit(0);
};

migrateCategories();
```

---

## 7. ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 7.1 ç±»åˆ«ç®¡ç†ç•Œé¢

**ç±»åˆ«åˆ—è¡¨é¡µé¢**ï¼š
- æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·åˆ›å»ºçš„ç±»åˆ«
- æ”¯æŒç¼–è¾‘å’Œåˆ é™¤ç±»åˆ«
- æ˜¾ç¤ºæ¯ä¸ªç±»åˆ«çš„ä½¿ç”¨ç»Ÿè®¡
- æä¾›ç±»åˆ«é¢œè‰²å’Œå›¾æ ‡è‡ªå®šä¹‰

**é¢„ç®—åˆ›å»ºæ”¹è¿›**ï¼š
- ä»é¢„å®šä¹‰ç±»åˆ«ä¸­é€‰æ‹©
- æ”¯æŒåˆ›å»ºæ–°ç±»åˆ«
- æ˜¾ç¤ºç±»åˆ«å›¾æ ‡å’Œæè¿°
- è‡ªåŠ¨å¡«å……ç±»åˆ«ä¿¡æ¯

**äº¤æ˜“è®°å½•æ”¹è¿›**ï¼š
- ä»ç±»åˆ«ä¸‹æ‹‰èœå•é€‰æ‹©
- æ”¯æŒå¿«é€Ÿç±»åˆ«åˆ‡æ¢
- æ˜¾ç¤ºç±»åˆ«å›¾æ ‡å’Œé¢œè‰²
- æŒ‰ç±»åˆ«ç­›é€‰å’Œç»Ÿè®¡

---

## 8. æ¼”ç¤ºå»ºè®®

### 8.1 å±•ç¤ºå½“å‰é—®é¢˜
1. **åˆ›å»ºé¢„ç®—**ï¼š
   - æ‰‹åŠ¨è¾“å…¥ç±»åˆ«åç§°
   - å®¹æ˜“æ‹¼å†™é”™è¯¯
   - æ— æ³•ç¡®ä¿ä¸€è‡´æ€§

2. **åˆ›å»ºäº¤æ˜“**ï¼š
   - æ‰‹åŠ¨è¾“å…¥ç±»åˆ«åç§°
   - ä¸é¢„ç®—ç±»åˆ«å¯èƒ½ä¸åŒ¹é…
   - ç»Ÿè®¡ä¸å‡†ç¡®

### 8.2 å±•ç¤ºæ”¹è¿›æ–¹æ¡ˆ
1. **ç±»åˆ«ç®¡ç†**ï¼š
   - ç»Ÿä¸€çš„ç±»åˆ«é€‰æ‹©ç•Œé¢
   - ç±»åˆ«å›¾æ ‡å’Œé¢œè‰²
   - ç±»åˆ«ä½¿ç”¨ç»Ÿè®¡

2. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - é¢„ç®—å’Œäº¤æ˜“å…±äº«ç±»åˆ«å¼•ç”¨
   - è‡ªåŠ¨åŒæ­¥å’Œç»Ÿè®¡
   - å‡å°‘æ•°æ®é”™è¯¯

### 8.3 æŠ€æœ¯è¦ç‚¹
"ç±»åˆ«ç®¡ç†ç³»ç»Ÿå±•ç¤ºäº†ï¼š
1. **æ•°æ®æ¨¡å‹è®¾è®¡**ï¼šå¤–é”®å…³è”å’Œå¼•ç”¨å®Œæ•´æ€§
2. **RESTful APIè®¾è®¡**ï¼šèµ„æºç®¡ç†å’ŒCRUDæ“ä½œ
3. **å‰ç«¯ç»„ä»¶åŒ–**ï¼šå¯å¤ç”¨çš„ç±»åˆ«ç»„ä»¶
4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šä¸‹æ‹‰é€‰æ‹©ã€è‡ªåŠ¨å®Œæˆã€è§†è§‰åé¦ˆ

---

## 9. æ€»ç»“

**å½“å‰é™åˆ¶**ï¼š
1. Budgetå’ŒTransactionä¸­çš„categoryå­—æ®µç‹¬ç«‹
2. ç¼ºä¹ç»Ÿä¸€çš„ç±»åˆ«ç®¡ç†
3. ç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¾“å…¥ç±»åˆ«åç§°
4. æ•°æ®ä¸€è‡´æ€§éš¾ä»¥ä¿è¯

**æ”¹è¿›ä»·å€¼**ï¼š
1. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿é¢„ç®—å’Œäº¤æ˜“æ•°æ®ä¸€è‡´
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç®€åŒ–ç±»åˆ«é€‰æ‹©ï¼Œå‡å°‘é”™è¯¯
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç±»åˆ«å›¾æ ‡ã€é¢œè‰²ã€æè¿°
4. **ç»Ÿè®¡åˆ†æ**ï¼šæŒ‰ç±»åˆ«çš„è¯¦ç»†è´¢åŠ¡åˆ†æ

è¿™ä¸ªæ”¹è¿›æ–¹æ¡ˆå°†æ˜¾è‘—æå‡åº”ç”¨çš„ä¸“ä¸šæ€§å’Œç”¨æˆ·ä½“éªŒï¼Œå±•ç¤ºäº†å¯¹æ•°æ®æ¨¡å‹è®¾è®¡çš„æ·±å…¥ç†è§£ã€‚